#!/bin/bash -e
## @brief manage configuration files (public/private)
# vim:se tw=78 ai si ts=2 sts=2 sw=2 et:
#
# configuration
#
#HOME=$(echo ~)

# functions
f_help () {
  echo "Syntax:"
  echo "  hal ${0##*/} i[nstall] # install configuration files from git repo"
  echo "  hal ${0##*/} d[iff]    # diff configuration files against ones in git repo"
  echo "  hal ${0##*/} u[pdate]  # update git repo with installed configuration files"
  exit
}

f_diff () {
# install the latest system skel files
  for p in /etc/skel/.* ; do
    f=$(basename "$p")
    if [ -d "$p" ]; then
      :
    elif [ -e "${HOME}/bin/dot/$f" ]; then
      echo " --- skip ---: diff -u $p  ${HOME}/$f"
    elif [ -f "$p" ]; then
      echo " $ diff -u $p  ${HOME}/$f"
      diff -u "$p" "${HOME}/$f" || true
    else
      :
    fi
  done
# install the latest dot files
  # shellcheck disable=2231
  for p in ${HOME}/bin/dot/.* ; do
    f=$(basename "$p")
    if [ -f "$p" ] && [ "$f" != ".config" ]; then
      echo " $ diff -u ~/bin/dot/$f  $f"
      diff -u "$p" "${HOME}/$f" || true
    fi
  done
  # shellcheck disable=2231
  for p in ${HOME}/bin/dot/.config/* ; do
    f=$(basename "$p")
    if [ -f "$p" ]; then
      echo " $ diff -u ~/bin/dot/.config/$f  ~/.config/$f"
      diff -u "$p" "${HOME}/.config/$f" || true
    fi
  done
}

f_install () {
# check diff
  f_diff
  echo "============================================================================"
# install the latest system skel files
  for p in /etc/skel/.* ; do
    f=$(basename "$p")
    if [ -f "$p" ]; then
      echo " $ cp -f $p ${HOME}/$f"
      cp -f "$p" "${HOME}/$f"
    fi
  done
# install the latest dot files
  # shellcheck disable=2231
  for p in ${HOME}/bin/dot/.* ; do
    f=$(basename "$p")
    if [ -f "$p" ] && [ "$f" != ".config" ]; then
      echo " $ cp -f ~/bin/dot/$f  ~/$f"
      cp -f "$p" "${HOME}/$f"
    fi
  done
  # shellcheck disable=2231
  for p in ${HOME}/bin/dot/.config/* ; do
    f=$(basename "$p")
    if [ -f "$p" ]; then
      echo " $ cp -f ~/bin/dot/.config/$f  ~/.config/$f"
      cp -f "$p" "${HOME}/.config/$f"
    fi
  done
}

f_update () {
# update the configuration files by the latest installed dot files
  # shellcheck disable=2231
  for p in ${HOME}/bin/dot/.* ; do
    f=$(basename "$p")
    if [ -f "$p" ] && [ "$f" != ".config" ]; then
      echo " $ cp -f ~/$f $p"
      cp -f "${HOME}/$f" "$p"
    fi
  done
  # shellcheck disable=2231
  for p in ${HOME}/bin/dot/.config/* ; do
    f=$(basename "$p")
    if [ -f "$p" ]; then
      echo " $ cp -f ~/.config/$f $p"
      cp -f "${HOME}/.config/$f" "$p"
    fi
  done
}

case "$1" in
  i*)
    f_install
        ;;
  d*)
    f_diff
        ;;
  u*)
    f_update
        ;;
  *)
    f_help
esac
